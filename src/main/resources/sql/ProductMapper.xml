<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ProductMapper">
 	
	<resultMap id="productSelectMap" type="product">
		<id     property="prodNo"         column="prod_no"         jdbcType="NUMERIC"/>
		<result property="prodName"       column="prod_name"       jdbcType="VARCHAR"/>
		<result property="prodDetail"     column="prod_detail"     jdbcType="VARCHAR"/>
		<result property="manufactureDay" column="manufacture_day" jdbcType="VARCHAR"/>
		<result property="price"          column="price"           jdbcType="NUMERIC"/>
		<result property="imageFile"      column="image_file"      jdbcType="VARCHAR"/>
		<result property="regDate"        column="reg_date"        jdbcType="DATE"/>
		<result property="proTranCode"    column="pro_tran_code"   jdbcType="VARCHAR"/>  
	</resultMap>
	

	<insert id="addProduct" parameterType="product">
	  <selectKey keyProperty="prodNo" resultType="int" order="BEFORE">
	    SELECT seq_product_prod_no.NEXTVAL FROM dual
	  </selectKey>
	  
	  INSERT INTO product (
	    prod_no, prod_name, prod_detail, manufacture_day, price, image_file, reg_date
	  ) VALUES (
	    #{prodNo},
	    #{prodName},
	    #{prodDetail},
	    SUBSTR(REPLACE(#{manufactureDay}, '-', ''), 1, 8),
	    #{price},
	    NULLIF(#{imageFile}, ''),
	    SYSDATE
	  )
	</insert>

	<select id="getProduct" parameterType="int" resultMap="productSelectMap">
		SELECT
			p.prod_no ,
			p.prod_name ,
			p.prod_detail ,
			/* LENGTH=8 일 때만 YYYY-MM-DD 로 포맷, 아니면 원문 */
			DECODE( LENGTH(NVL(p.manufacture_day,'')),
							8, SUBSTR(p.manufacture_day,1,4) || '-' || SUBSTR(p.manufacture_day,5,2) || '-' || SUBSTR(p.manufacture_day,7,2),
							p.manufacture_day ) 		AS manufacture_day ,
			p.price ,
			p.image_file ,
			p.reg_date ,
			DECODE(p.pro_tran_code, NULL, '판매중', p.pro_tran_code) AS pro_tran_code
		FROM product p
		WHERE p.prod_no = #{value}
	</select>

	<update id="updateProduct" parameterType="product">
	  UPDATE product
	  SET
	    prod_name       = #{prodName},
	    prod_detail     = #{prodDetail},
	    manufacture_day = NVL(SUBSTR(REPLACE(#{manufactureDay}, '-', ''), 1, 8), manufacture_day),
	    price           = #{price}
	    <if test="imageFile != null and imageFile != ''">
	      , image_file = #{imageFile, jdbcType=VARCHAR}
	    </if>
	  WHERE prod_no = #{prodNo}
	</update>
	
	<update id="updateProTranCodeToSold" parameterType="int">
	  UPDATE product
	     SET pro_tran_code = '판매완료'
	   WHERE prod_no = #{value}
	     AND NVL(pro_tran_code, '판매중') = '판매중'
	</update>
	
	<update id="updateProTranCodeToSale" parameterType="int">
	  UPDATE product
	     SET pro_tran_code = '판매중'
	   WHERE prod_no = #{value}
	     AND pro_tran_code = '판매완료'
	</update>
	
	<update id="updateProTranCode" parameterType="map">
	  UPDATE product
	     SET pro_tran_code = #{proTranCode}
	   WHERE prod_no = #{prodNo}
	</update>

	 
	<select id="getProductList" parameterType="search" resultMap="productSelectMap">
		SELECT *
		FROM (
			SELECT inner_table.* , ROWNUM AS row_seq
			FROM (
				SELECT
					p.prod_no ,
					p.prod_name ,
					p.prod_detail ,
					DECODE( LENGTH(NVL(p.manufacture_day,'')),
									8, SUBSTR(p.manufacture_day,1,4) || '-' || SUBSTR(p.manufacture_day,5,2) || '-' || SUBSTR(p.manufacture_day,7,2),
									p.manufacture_day ) 	AS manufacture_day ,
					p.price ,
					p.image_file ,
					p.reg_date ,
					DECODE(p.pro_tran_code, NULL, '판매중', p.pro_tran_code) AS pro_tran_code
				FROM product p
				<if test="searchCondition != null">
					<where>
						<if test="searchCondition == 0 and searchKeyword != '' ">
							p.prod_name LIKE '%' || #{searchKeyword} || '%'
						</if>
						<if test="searchCondition == 1 and searchKeyword != '' ">
							TO_CHAR(p.price) = #{searchKeyword}
						</if>
					</where>
				</if>
				ORDER BY p.reg_date DESC , p.prod_no DESC
			) inner_table
			WHERE ROWNUM <![CDATA[ <= ]]> #{endRowNum}
		)
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}
	</select>

	<select id="getTotalCount" parameterType="search" resultType="int">
		SELECT COUNT(*)
		FROM (
			SELECT p.prod_no
			FROM product p
			<if test="searchCondition != null">
				<where>
					<if test="searchCondition == 0 and searchKeyword != null and searchKeyword != ''">
						p.prod_name LIKE '%' || #{searchKeyword} || '%'
					</if>
					<if test="searchCondition == 1 and searchKeyword != null and searchKeyword != ''">
						  TO_CHAR(p.price) = #{searchKeyword}
					</if>
				</where>
			</if>
		) countTable
	</select>
	 
	<delete id="deleteProduct" parameterType="int">
		DELETE FROM product
		WHERE prod_no = #{value}
	</delete>	

	<select id="getNewProductList" parameterType="int" resultMap="productSelectMap">
		SELECT *
		FROM (
			SELECT
				p.prod_no ,
				p.prod_name ,
				p.prod_detail ,
				DECODE( LENGTH(NVL(p.manufacture_day,'')),
								8, SUBSTR(p.manufacture_day,1,4) || '-' || SUBSTR(p.manufacture_day,5,2) || '-' || SUBSTR(p.manufacture_day,7,2),
								p.manufacture_day ) 	AS manufacture_day ,
				p.price ,
				p.image_file ,
				p.reg_date ,
				DECODE(p.pro_tran_code, NULL, '판매중', p.pro_tran_code) AS pro_tran_code
			FROM product p
			ORDER BY p.reg_date DESC
		)
		WHERE ROWNUM <![CDATA[ <= ]]> #{value}
	</select>

	<select id="getBestProductList" parameterType="int" resultMap="productSelectMap">
	    SELECT *
	    FROM (
	        SELECT
	            p.prod_no ,
	            p.prod_name ,
	            p.prod_detail ,
	            DECODE( LENGTH(NVL(p.manufacture_day,'')),
	                            8, SUBSTR(p.manufacture_day,1,4) || '-' || SUBSTR(p.manufacture_day,5,2) || '-' || SUBSTR(p.manufacture_day,7,2),
	                            p.manufacture_day )     AS manufacture_day ,
	            p.price ,
	            p.image_file ,
	            p.reg_date ,
	            DECODE(p.pro_tran_code, NULL, '판매중', p.pro_tran_code) AS pro_tran_code ,
	            
	            NVL(tran_count.total_sold, 0) AS total_sold
	            
	        FROM product p
	        
	        LEFT JOIN (
	            SELECT
	                t.prod_no,
	                COUNT(t.prod_no) AS total_sold
	            FROM transaction t
	            GROUP BY t.prod_no
	        ) tran_count ON p.prod_no = tran_count.prod_no
	        
	        ORDER BY total_sold DESC, p.reg_date DESC
	    )
	    WHERE ROWNUM <![CDATA[ <= ]]> #{value}
	</select>

</mapper>